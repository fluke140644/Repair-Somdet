{% extends 'baseadmin.html' %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto mt-10 bg-white p-8 rounded-lg shadow-lg border border-gray-200">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° </h2>
    <form method="post" class="space-y-6" action="{% url 'repair_edit' repair.id %}">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">


            <div>
                <label class="block text-gray-700 font-medium mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                {{ form.category }}
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
                {{ form.sub_item }}
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
                {{ form.status_user }}
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                {{ form.device_code }}
            </div>

            <div>
    <label class="block text-gray-700 font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
    <div id="asset-number-container">
        {{ form.asset_number }}
    </div>
</div>

<div class="mt-2">
    <label>
        {{ form.unknown_device }} ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå
    </label>
</div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                {{ form.department }}
            </div>

            <div class="md:col-span-2">
                <label class="block text-gray-700 font-medium mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                {{ form.detail }}
            </div>

            <div class="md:col-span-2">
                <label class="block text-gray-700 font-medium mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                <div class="w-1/4 bg-gray-100 text-gray-600 px-4 py-2 rounded-md">
                    {{ repair.get_status_display }}
                </div>
            </div>

            <div></div>

            <div class="md:col-span-2">
                <label class="block text-gray-700 font-medium mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
                    {{ form.remark }}
            </div>


            <div>
                <label class="block text-gray-700 font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</label>
                {{ form.reported_by }}
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
                {{ form.assigned_to }}
            </div>
        </div>
        <div class="flex justify-between items-start mt-6">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
            <div class="grid grid-cols-2 gap-4">
                <button type="button"
                    class="status-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded shadow"
                    data-id="{{ repair.id }}" data-status="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>

                <button type="button"
                    class="status-btn w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded shadow"
                    data-id="{{ repair.id }}" data-status="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>

                <button type="button"
                    class="status-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded shadow"
                    data-id="{{ repair.id }}" data-status="repairclaim">‡∏ã‡πà‡∏≠‡∏°/‡πÄ‡∏Ñ‡∏•‡∏°</button>

                <button type="button"
                    class="status-btn w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded shadow"
                    data-id="{{ repair.id }}" data-status="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏ß‡∏≤: ‡∏Å‡∏•‡∏±‡∏ö + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
            <div class="space-x-4 ml-6">
                <a href="{% url 'pl_admin' %}"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">
                    ‡∏Å‡∏•‡∏±‡∏ö
                </a>
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded shadow">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>

</div>

</form>
</div>

<script>
    const checkbox = document.getElementById("id_unknown_device");
    const assetContainer = document.getElementById("asset-number-container");

    function toggleAssetField() {
        if (checkbox.checked) {
            assetContainer.innerHTML = '<div class="text-muted">‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</div>';
        } else {
            assetContainer.innerHTML = '{{ form.asset_number|escapejs }}';
        }
    }

    checkbox.addEventListener("change", toggleAssetField);
    document.addEventListener("DOMContentLoaded", toggleAssetField);
</script>

<script>
    document.querySelectorAll('.status-btn').forEach(button => {
        button.addEventListener('click', () => {
            const reportId = button.getAttribute('data-id');
            const newStatus = button.getAttribute('data-status');

            fetch(`/update-status/${reportId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ status: newStatus })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        location.reload();
                    } else {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                    }
                });
        });
    });


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


</script>

<script>
    $(document).ready(function () {
        $('#id_reported_by').select2({
            width: '100%',
            placeholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á...",
            allowClear: true,
            containerCssClass: 'tailwind-select2',
            dropdownCssClass: 'tailwind-dropdown'
        });
    });
</script>
{% endblock %}